<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Компас</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #0e1117;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      transition: background-color 200ms ease;
    }

    .card {
      background: #1a1f29;
      border-radius: 16px;
      padding: 24px 32px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      text-align: center;
      max-width: 360px;
      width: 100%;
    }

    .dist {
      font-size: 64px;
      font-weight: 700;
      margin: 0 0 12px;
      letter-spacing: 1px;
    }

    .info {
      font-size: 14px;
      opacity: .85;
      margin-bottom: 16px;
    }

    .status {
      font-size: 13px;
      color: #9aa0a6;
    }
  </style>
  <script>
    function toRad(d){ return d * Math.PI / 180; }
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function notifyBotSuccess(uid) {
      try {
        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.sendData(`SUCCESS_${uid}`);
          window.Telegram.WebApp.close();
        } else {
          console.warn("WebApp API недоступно, бот не уведомлен.");
        }
      } catch (e) {
        console.error("Ошибка при уведомлении бота:", e);
      }
    }

    let fired = false;

    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      const tLat = parseFloat(params.get('lat'));
      const tLon = parseFloat(params.get('lon'));
      const radius = parseInt(params.get('r') || 15, 10);
      const uid = params.get('uid');

      const distEl = document.getElementById('dist');
      const infoEl = document.getElementById('info');
      const statusEl = document.getElementById('status');

      if (Number.isNaN(tLat) || Number.isNaN(tLon)) {
        infoEl.textContent = 'Некорректные координаты';
        return;
      }

      if (!('geolocation' in navigator)) {
        infoEl.textContent = 'Геолокация не поддерживается';
        return;
      }

      function setBg(dist) {
        const max = Math.max(radius * 10, 200);
        const t = Math.max(0, Math.min(1, 1 - dist / max));
        const r = Math.round(40 + (1 - t) * 120);
        const g = Math.round(60 + t * 160);
        const b = 40;
        document.body.style.backgroundColor = `rgb(${r},${g},${b})`;
      }

      function onpos(pos) {
        const { latitude, longitude } = pos.coords;
        const d = haversine(latitude, longitude, tLat, tLon);
        distEl.textContent = d + " м";
        infoEl.textContent = "Радиус цели: " + radius + " м";
        setBg(d);

        if (!fired && d <= radius) {
          fired = true;
          notifyBotSuccess(uid);
        }
      }

      function onerr(err) {
        statusEl.textContent = "Ошибка геолокации: " + err.message;
      }

      navigator.geolocation.watchPosition(onpos, onerr, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
      });

      // страховочный опрос
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(onpos, onerr, {
          enableHighAccuracy: true
        });
      }, 5000);
    });
  </script>
</head>
<body>
  <div class="card">
    <div class="dist" id="dist">— м</div>
    <div class="info" id="info">Ожидание геопозиции…</div>
    <div class="status" id="status"></div>
  </div>
</body>
</html>
