<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–æ–º–ø–∞—Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #111;
      color: #eee;
    }
    #distance {
      font-size: 1.5em;
      margin: 20px 0;
    }
    #status {
      margin: 20px 0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>üß≠ –ö–æ–º–ø–∞—Å</h2>
  <div id="distance">‚è≥ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç...</div>
  <div id="status"></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ---
    const urlParams = new URLSearchParams(window.location.search);
    const targetLat = parseFloat(urlParams.get("lat"));
    const targetLon = parseFloat(urlParams.get("lon"));
    const uid = urlParams.get("uid");

    const distanceEl = document.getElementById("distance");
    const statusEl = document.getElementById("status");

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => (x * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updatePosition(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const dist = haversine(lat, lon, targetLat, targetLon);

      distanceEl.textContent = `üìè ${dist.toFixed(1)} –º`;

      if (dist <= 15) {
        statusEl.textContent = "‚úÖ –ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –∑–æ–Ω—É";

        tg.sendData(JSON.stringify({
          action: "compass_success",
          uid: uid || tg.initDataUnsafe?.user?.id,
          ts: Date.now()
        }));

        tg.close();
      } else {
        statusEl.textContent = "‚ùå –î–∞–ª–µ–∫–æ...";
      }
    }

    function error(err) {
      statusEl.textContent = "–û—à–∏–±–∫–∞ –≥–µ–æ: " + err.message;
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(updatePosition, error, {
        enableHighAccuracy: true,
        maximumAge: 1000
      });
    } else {
      statusEl.textContent = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
    }
  </script>
</body>
</html>
