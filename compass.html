<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ö–æ–º–ø–∞—Å</title>
  <style>
    body {
      font-family: sans-serif;
      background: #0c0f14;
      color: #e8e8e8;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .dist-wrapper {
      width: 200px; height: 200px; border-radius: 50%;
      background: radial-gradient(circle at center, #1f252a, #13181c);
      display: flex; align-items: center; justify-content: center;
      font-size: 42px; font-weight: bold;
    }
    .info { margin-top: 14px; font-size: 14px; opacity: 0.8; text-align: center; }
  </style>
</head>
<body>
  <div class="dist-wrapper"><div id="dist">‚Äî –º</div></div>
  <div class="info" id="info">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>

  <script>
    // --- utils ---
    function b64urlToStr(b64){
      b64 = b64.replace(/-/g,'+').replace(/_/g,'/');
      const pad = b64.length % 4;
      if (pad) b64 += '='.repeat(4-pad);
      return atob(b64);
    }
    function toRad(d){ return d*Math.PI/180 }
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371000, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
    }

    // --- parse payload ---
    function getParams(){
      const params = new URLSearchParams(location.search);
      let lat, lon, r, uid;

      // —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º payload p
      let p = params.get('p');
      if (!p && location.hash.startsWith('#')) {
        p = new URLSearchParams(location.hash.substring(1)).get('p');
      }
      if (p) {
        try {
          const json = b64urlToStr(p);
          const obj = JSON.parse(json);
          lat = parseFloat(obj.lat);
          lon = parseFloat(obj.lon);
          r   = parseInt(obj.r ?? 15,10);
          uid = obj.uid;
        } catch(e){ console.log("payload decode error", e); }
      }

      // fallback: –ø—Ä—è–º—ã–µ query
      if (!lat) lat = parseFloat(params.get('lat'));
      if (!lon) lon = parseFloat(params.get('lon'));
      if (!r)   r   = parseInt(params.get('r') ?? 15,10);
      if (!uid) uid = params.get('uid');

      return {lat, lon, r, uid};
    }

    // --- notify bot ---
    function notifyBot(uid){
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        const data = JSON.stringify({action:'compass_success', uid:uid, ts:Date.now()});
        try {
          window.Telegram.WebApp.sendData(data);
        } catch(e){ console.log("sendData error", e); }
        setTimeout(()=>window.Telegram.WebApp.close(), 500);
      } else {
        alert("–¢–æ—á–∫–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! (–Ω–µ—Ç WebApp –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)");
      }
    }

    // --- main ---
    window.addEventListener('DOMContentLoaded', ()=>{
      const {lat, lon, r, uid} = getParams();
      const distEl = document.getElementById('dist');
      const infoEl = document.getElementById('info');

      if (isNaN(lat) || isNaN(lon)){
        infoEl.textContent = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã";
        return;
      }
      infoEl.textContent = "–†–∞–¥–∏—É—Å: "+r+" –º";

      let fired=false;
      const onpos = (pos)=>{
        const {latitude, longitude} = pos.coords;
        const d = haversine(latitude, longitude, lat, lon);
        distEl.textContent = d+" –º";
        if (!fired && d <= r){
          fired=true;
          infoEl.textContent = "üéØ –î–û–°–¢–ò–ì–ù–£–¢–ê –¢–û–ß–ö–ê!";
          notifyBot(uid);
        }
      };
      const onerr=(err)=>{ infoEl.textContent="–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: "+err.message; };

      if ('geolocation' in navigator){
        navigator.geolocation.watchPosition(onpos, onerr, {enableHighAccuracy:true});
        setInterval(()=>navigator.geolocation.getCurrentPosition(onpos, onerr, {enableHighAccuracy:true}), 5000);
      } else {
        infoEl.textContent="–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
      }
    });
  </script>
</body>
</html>
