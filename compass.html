<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Компас</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #101410; color: #eee; transition: background-color 150ms linear; display: flex; flex-direction: column; align-items: stretch; min-height: 100vh; }
    .dist { font-size: 56px; text-align: center; margin-top: 16px; font-weight: 700; letter-spacing: 1px; }
    .info { font-size: 13px; opacity: .8; text-align: center; margin-top: 8px; }
    .controls { margin-top: auto; padding-top: 16px; display: flex; flex-direction: column; gap: 12px; align-items: stretch; }
    .controls .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .pill { padding: 10px 12px; border-radius: 10px; border: 1px solid #2a2; background: rgba(0,0,0,0.15); color: #eee; cursor: pointer; text-align: center; }
    .pill.secondary { border-color: #444; }
    .muted { color: #a9b; font-size: 12px; text-align: center; margin-top: 8px; }
    label { display: flex; align-items: center; gap: 8px; font-size: 14px; }
  </style>
  <script>
    function b64urlToStr(b64){ b64=b64.replace(/-/g,'+').replace(/_/g,'/'); const pad=b64.length%4; if(pad) b64+='='.repeat(4-pad); return atob(b64); }
    function tryDecodePayload(){
      const sp = new URLSearchParams(location.search);
      let p = sp.get('p');
      if (!p && location.hash.startsWith('#')) p = new URLSearchParams(location.hash.substring(1)).get('p');
      if(!p) return null;
      try{ const json=b64urlToStr(p); return JSON.parse(json);}catch(e){ return null; }
    }
    function toRad(d){return d*Math.PI/180}
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371000, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return Math.round(R*c);
    }

    const T_MIN = 1.0, T_MAX = 5.0, D_MIN = 20, D_MAX = 1000, K = 9;
    function normY(d){ const dClamped = Math.min(D_MAX, Math.max(D_MIN, d)); const x = (dClamped - D_MIN) / (D_MAX - D_MIN); return Math.log(1 + K * x) / Math.log(1 + K); }
    function intervalSec(d){ if(d > D_MAX) return null; if(d <= D_MIN) return T_MIN; const y=normY(d); return T_MIN + (T_MAX - T_MIN) * y; }
    function toneHz(d){ const fMin=650,fMax=950; if(d>D_MAX) return fMin; const y=(d<=D_MIN)?0:normY(d); return Math.round(fMax - (fMax - fMin) * y); }

    let audioCtx=null, masterGain=null;
    function ensureAudio(){ if(audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value=0; masterGain.connect(audioCtx.destination); }
    function beepOnce(freq, gain, durMs=120){ if(!audioCtx) return; const osc=audioCtx.createOscillator(); const g=audioCtx.createGain(); osc.frequency.value=freq; osc.type='sine'; g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(gain,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(Math.max(1e-4,gain*0.001),audioCtx.currentTime+durMs/1000); osc.connect(g).connect(masterGain); osc.start(); osc.stop(audioCtx.currentTime+durMs/1000+0.02); }

    let target=null, lastD=null, timer=null, lastBeepAt=0, allowSound=false, fired=false;

    function setBg(dist, radius){
      const max = Math.max(radius*10, 200);
      const t = Math.max(0, Math.min(1, 1 - dist/max));
      const r = Math.round(30 + (1-t)*120);
      const g = Math.round(40 + t*180);
      const b = 30;
      document.body.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
    }
    function schedule(ms){ if(timer) clearTimeout(timer); timer=setTimeout(tick, Math.max(100, ms|0)); }
    function tick(){
      const snd = document.getElementById('snd').checked;
      const vib = document.getElementById('vib').checked;
      const vol = parseFloat(document.getElementById('vol').value||'0.12');
      const tglSound = true; // always on by default
      if(!lastD){ schedule(500); return; }
      const t = intervalSec(lastD);
      // интервал скрыт из UI, но оставлен в логике
      if(t == null){ schedule(500); return; }
      const now=performance.now();
      if(now - lastBeepAt >= t*1000 - 20){
        lastBeepAt = now;
        if(snd && allowSound){ ensureAudio(); audioCtx.resume(); masterGain.gain.value=vol; const gain = (lastD>D_MAX?0:(lastD<=D_MIN?0.16:0.06+(0.16-0.06)*(1-normY(lastD)))); beepOnce(toneHz(lastD), gain*vol/0.12); }
        if(vib && navigator.vibrate) navigator.vibrate(50);
      }
      schedule(100);
    }

    function deepLinkToBot(){
      const bn = target?.bn; const uid = target?.uid;
      if (bn) {
        try { location.href = `https://t.me/${bn}?start=CV_${uid||''}`; } catch(e) {}
      }
      setTimeout(()=>window.close(), 400);
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      target = tryDecodePayload();
      const params=new URLSearchParams(location.search);
      const tLat = parseFloat(target?.lat ?? params.get('lat'));
      const tLon = parseFloat(target?.lon ?? params.get('lon'));
      const radius = parseInt(target?.r ?? params.get('r') ?? 15, 10);
      if (Number.isNaN(tLat) || Number.isNaN(tLon)) { document.getElementById('info').textContent = 'Некорректные координаты'; return; }

      const distEl=document.getElementById('dist');
      const info=document.getElementById('info');

      if(!('geolocation' in navigator)){ info.textContent='Геолокация не поддерживается'; return; }

      const onpos = (pos)=>{
        const {latitude, longitude} = pos.coords;
        const d=haversine(latitude, longitude, tLat, tLon);
        lastD = d; distEl.textContent=d+" м"; info.textContent = "Радиус: "+radius+" м"; setBg(d, radius);
        if(!fired && d <= radius){ fired=true; deepLinkToBot(); }
      };
      const onerr = (err)=>{ info.textContent='Ошибка геолокации: '+err.message; };
      navigator.geolocation.watchPosition(onpos, onerr, {enableHighAccuracy:true, maximumAge:0, timeout:10000});
      setInterval(()=>navigator.geolocation.getCurrentPosition(onpos, onerr, {enableHighAccuracy:true}), 5000);

      // первый пользовательский жест для активации AudioContext: на изменение громкости
      document.getElementById('vol').addEventListener('input', ()=>{ allowSound=true; ensureAudio(); audioCtx.resume(); });

      schedule(200);
    });
  </script>
</head>
<body>
  <div class="dist" id="dist">— м</div>
  <div class="info" id="info">Инициализация…</div>

  <div class="controls">
    <div class="muted">Настройки пеленгатора</div>
    <div class="row"><label><input id="snd" type="checkbox" checked/> Звук</label></div>
    <div class="row"><label><input id="vib" type="checkbox"/> Вибрация</label></div>
    <div class="row"><label style="width:100%">Сила сигнала <input id="vol" style="width:100%" type="range" min="0" max="1" step="0.01" value="0.12"/></label></div>
  </div>
</body>
</html>


