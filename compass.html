<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#39d98a"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="telegram:web_app" content="true"/>
<meta name="telegram:web_app:version" content="6.0"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>–ö–æ–º–ø–∞—Å</title>
<style>
html, body {
  margin:0; padding:0; height:100%;
  font-family:"Inter", sans-serif;
  background: linear-gradient(160deg, #0c0f14 0%, #1a1f24 100%);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:#e8e8e8; overflow:hidden;
}

.compass-wrapper {
  position: relative;
  width: 250px; height: 250px;
  border-radius: 50%;
  background: radial-gradient(circle at center, #1f252a 0%, #13181c 100%);
  box-shadow: 0 0 30px rgba(0,255,128,0.3);
  display:flex; align-items:center; justify-content:center;
  overflow: visible;
}

.compass-circle {
  position: absolute;
  width: 90%;
  height: 90%;
  border: 2px solid rgba(0,255,128,0.3);
  border-radius: 50%;
  box-shadow: 0 0 10px rgba(0,255,128,0.2) inset;
}

.locator {
  position: absolute;
  width: 30px; height: 30px;
  border-radius: 50%;
  background-color: red;
  opacity: 0.7;
  z-index:1;
  filter: drop-shadow(0 0 15px red);
}

/* –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π –¥—ã–º —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º */
.pulse {
  position: absolute;
  width: 50px; height: 50px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(255,0,0,0.4) 0%, rgba(255,0,0,0) 70%);
  opacity: 0.6;
  animation: pulseAnim 2s infinite ease-out;
  z-index:0;
  filter: blur(20px);
}

.pulse:nth-child(1){ animation-delay: 0s; }
.pulse:nth-child(2){ animation-delay: 0.6s; }
.pulse:nth-child(3){ animation-delay: 1.2s; }

@keyframes pulseAnim {
  0% { transform: scale(0.6); opacity:0.6; }
  50% { transform: scale(2.2); opacity:0.2; }
  100% { transform: scale(0.6); opacity:0.6; }
}

.info {
  margin-top: 16px;
  font-size: 16px;
  opacity:0.9;
  text-align:center;
}

.debug {
  position: fixed;
  top: 10px; left: 10px; right: 10px;
  background: rgba(0,0,0,0.8); color:#00ff80;
  padding:8px; font-size:12px; border-radius:5px;
  max-height:200px; overflow-y:auto; z-index:1000;
  display:none;
}
.debug.show { display:block; }
</style>
</head>
<body>
<div class="debug" id="debug"></div>

<div class="compass-wrapper">
  <div class="compass-circle"></div>
  <div class="locator" id="locator"></div>
  <div class="pulse"></div>
  <div class="pulse"></div>
  <div class="pulse"></div>
</div>

<div class="info" id="info">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>

<script>
function debugLog(msg){
  console.log(msg);
  const dbg=document.getElementById('debug');
  if(dbg){ dbg.innerHTML += msg+"<br>"; dbg.classList.add('show'); dbg.scrollTop=dbg.scrollHeight; }
}

// –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ ‚Üí —Ü–≤–µ—Ç (–∫—Ä–∞—Å–Ω—ã–π ‚Üí –∑–µ–ª—ë–Ω—ã–π)
function getColorByDistance(dist, radius){
  const clamped = Math.min(dist, radius);
  const ratio = 1 - clamped/radius; // 1 = —Ü–µ–ª—å –±–ª–∏–∑–∫–æ, 0 = –¥–∞–ª–µ–∫–æ
  const r = Math.floor(255 * (1-ratio));
  const g = Math.floor(255 * ratio);
  return `rgb(${r},${g},0)`;
}

function toRad(d){ return d*Math.PI/180 }
function haversine(lat1, lon1, lat2, lon2){
  const R=6371000, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return Math.round(R*c);
}

function notifyBot(uid){
  if(window.Telegram?.WebApp?.sendData){
    const data = JSON.stringify({ action:'compass_success', uid:uid, ts:Date.now() });
    window.Telegram.WebApp.sendData(data);
    setTimeout(()=>window.Telegram.WebApp.close(),500);
  }
}

// MAIN
window.addEventListener('DOMContentLoaded', ()=>{
  const distEl = document.getElementById('info');
  const locatorEl = document.getElementById('locator');
  const pulses = document.querySelectorAll('.pulse');

  // –ü—Ä–∏–º–µ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–ª–∏
  const targetLat = 55.234;
  const targetLon = 37.656;
  const radius = 15;
  const uid = 123456789;

  if(!('geolocation' in navigator)){
    distEl.textContent="–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
    return;
  }

  let arrived = false;
  navigator.geolocation.watchPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    const distance = haversine(latitude, longitude, targetLat, targetLon);
    distEl.textContent = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance} –º`;

    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ª–æ–∫–∞—Ç–æ—Ä–∞ –∏ –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–≥–æ –¥—ã–º–∞
    const color = getColorByDistance(distance, radius);
    locatorEl.style.backgroundColor = color;
    locatorEl.style.filter = `drop-shadow(0 0 20px ${color})`;
    pulses.forEach(p => {
      p.style.background = `radial-gradient(circle, ${color} 0%, rgba(0,0,0,0) 70%)`;
    });

    if(!arrived && distance <= radius){
      arrived = true;
      distEl.textContent = "üéØ –î–û–°–¢–ò–ì–ù–£–¢–ê –¢–û–ß–ö–ê!";
      notifyBot(uid);
    }
  }, err=>{ distEl.textContent="–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: "+err.message }, {enableHighAccuracy:true});
});
</script>
</body>
</html>
