<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#39d98a"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="telegram:web_app" content="true"/>
  <meta name="telegram:web_app:version" content="6.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' https: data: blob:; connect-src 'self' https: wss:;">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>–ö–æ–º–ø–∞—Å</title>
  <style>
    /* === –í–ê–®–ò –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø === */
    body { font-family:"Inter",sans-serif; margin:0;padding:0; background:linear-gradient(160deg,#0c0f14 0%,#1a1f24 100%); color:#e8e8e8; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; }
    .dist-wrapper { width:200px; height:200px; border-radius:50%; background: radial-gradient(circle at center, #1f252a, #13181c); display:flex; align-items:center; justify-content:center; box-shadow:0 0 20px rgba(0,255,128,0.2); position:relative; }
    .dist { font-size:48px; font-weight:700; text-align:center; }
    .info { margin-top:14px; font-size:14px; opacity:0.85; text-align:center; }

    /* === –ü–£–õ–¨–°–ò–†–£–Æ–©–ò–ô –õ–û–ö–ê–¢–û–†/–î–´–ú === */
    .locator { position:absolute; width:30px;height:30px;border-radius:50%; background:red; opacity:0.7; z-index:1; filter: drop-shadow(0 0 15px red); top:50%; left:50%; transform:translate(-50%, -50%);}
    .pulse { position:absolute; width:50px; height:50px; border-radius:50%; background:radial-gradient(circle, rgba(255,0,0,0.4) 0%, rgba(0,0,0,0) 70%); opacity:0.6; animation:pulseAnim 2s infinite ease-out; z-index:0; filter:blur(20px); top:50%; left:50%; transform:translate(-50%,-50%);}
    .pulse:nth-child(1){animation-delay:0s;} .pulse:nth-child(2){animation-delay:0.6s;} .pulse:nth-child(3){animation-delay:1.2s;}
    @keyframes pulseAnim { 0%{transform:translate(-50%,-50%) scale(0.6); opacity:0.6;} 50%{transform:translate(-50%,-50%) scale(2.2); opacity:0.2;} 100%{transform:translate(-50%,-50%) scale(0.6); opacity:0.6;} }

    .debug { position:fixed; top:10px; left:10px; right:10px; background:rgba(0,0,0,0.8); color:#00ff80; padding:10px; font-size:12px; border-radius:5px; max-height:200px; overflow-y:auto; z-index:1000; display:none; }
    .debug.show { display:block; }
  </style>
</head>
<body>
  <div class="debug" id="debug"></div>

  <!-- === –ö–û–ú–ü–ê–° –° –õ–û–ö–ê–¢–û–†–û–ú === -->
  <div class="dist-wrapper">
    <div class="dist" id="dist">‚Äî –º</div>
    <div class="locator" id="locator"></div>
    <div class="pulse"></div>
    <div class="pulse"></div>
    <div class="pulse"></div>
  </div>
  <div class="info" id="info">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>

  <!-- === –í–ê–® –°–ö–†–ò–ü–¢ –ü–û–õ–ù–û–°–¢–¨–Æ –°–û–•–†–ê–ù–Å–ù === -->
  <script>
    // === –í–ê–® –°–ö–†–ò–ü–¢ –¢–£–¢ ===
    (function(){
      // –≤—Å–µ –≤–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏: debugLog, tryDecodePayload, haversine, notifyBot –∏ –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
      // ...
      const locatorEl=document.getElementById('locator');
      const pulses=document.querySelectorAll('.pulse');

      window.addEventListener('DOMContentLoaded', ()=>{
        const distEl=document.getElementById('dist');
        const infoEl=document.getElementById('info');

        const params=new URLSearchParams(location.search);
        const payload=tryDecodePayload();

        const tLat=parseFloat(payload?.lat ?? params.get('lat'));
        const tLon=parseFloat(payload?.lon ?? params.get('lon'));
        const radius=parseInt(payload?.r ?? params.get('r') ?? 15,10);
        const uid=payload?.uid ?? params.get('uid');

        if(Number.isNaN(tLat) || Number.isNaN(tLon)){ infoEl.textContent="–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"; return; }
        if(!('geolocation' in navigator)){ infoEl.textContent="–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"; return; }

        let arrived=false;
        navigator.geolocation.watchPosition(pos=>{
          const {latitude,longitude}=pos.coords;
          const distance=haversine(latitude,longitude,tLat,tLon);
          distEl.textContent=distance+" –º";

          // === –ü–£–õ–¨–° –ò –¶–í–ï–¢ –ü–û –†–ê–°–°–¢–û–Ø–ù–ò–Æ ===
          const ratio=Math.min(distance,radius)/radius;
          const r=Math.floor(255*ratio), g=Math.floor(255*(1-ratio));
          const color=`rgb(${r},${g},0)`;
          locatorEl.style.backgroundColor=color;
          locatorEl.style.filter=`drop-shadow(0 0 20px ${color})`;
          pulses.forEach(p=>p.style.background=`radial-gradient(circle, ${color} 0%, rgba(0,0,0,0) 70%)`);

          if(!arrived && distance<=radius){
            arrived=true;
            infoEl.textContent="üéØ –î–û–°–¢–ò–ì–ù–£–¢–ê –¢–û–ß–ö–ê!";
            notifyBot(uid);
          }
        }, err=>{ infoEl.textContent="–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: "+err.message; }, {enableHighAccuracy:true});
      });
    })();
  </script>
</body>
</html>
