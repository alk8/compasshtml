<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Компас</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #101410; color: #eee; transition: background-color 150ms linear; display: flex; flex-direction: column; align-items: center; }
    .dist { font-size: 56px; text-align: center; margin-top: 24px; font-weight: 700; letter-spacing: 1px; }
    .info { font-size: 13px; opacity: .7; text-align: center; margin-top: 10px; }
  </style>
  <script>
    // Обфускация параметров: Base64URL JSON в hash (#p=...)
    function b64urlToStr(b64){ b64=b64.replace(/-/g,'+').replace(/_/g,'/'); const pad=b64.length%4; if(pad) b64+='='.repeat(4-pad); return atob(b64); }
    function tryDecodePayload(){
      const sp = new URLSearchParams(location.search);
      let p = sp.get('p');
      if (!p && location.hash.startsWith('#')) {
        const hs = new URLSearchParams(location.hash.substring(1));
        p = hs.get('p');
      }
      if(!p) return null;
      try{ const json=b64urlToStr(p); return JSON.parse(json);}catch(e){ return null; }
    }
    function toRad(d){return d*Math.PI/180}
    function toDeg(r){return r*180/Math.PI}
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371000;
      const dLat=toRad(lat2-lat1);
      const dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return Math.round(R*c);
    }
    function bearing(lat1, lon1, lat2, lon2){
      const φ1=toRad(lat1), φ2=toRad(lat2), λ=toRad(lon2-lon1);
      const y=Math.sin(λ)*Math.cos(φ2);
      const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ);
      const θ=toDeg(Math.atan2(y,x));
      return (θ+360)%360;
    }
    function sector8(b){
      const d=((b%360)+360)%360;
      if(d>=337.5||d<22.5) return ['↑','С'];
      if(d<67.5) return ['↗','СВ'];
      if(d<112.5) return ['→','В'];
      if(d<157.5) return ['↘','ЮВ'];
      if(d<202.5) return ['↓','Ю'];
      if(d<247.5) return ['↙','ЮЗ'];
      if(d<292.5) return ['←','З'];
      return ['↖','СЗ'];
    }
    async function validate(activeGameId, teamId){
      alert('Валидация в этом демо не подключена к backend');
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      const dec=tryDecodePayload();
      const params=new URLSearchParams(location.search);
      const tLat = parseFloat(dec?.lat ?? params.get('lat'));
      const tLon = parseFloat(dec?.lon ?? params.get('lon'));
      const radius = parseInt(dec?.r ?? params.get('r') ?? 15, 10);
      if (Number.isNaN(tLat) || Number.isNaN(tLon)) {
        document.getElementById('info').textContent = 'Некорректные координаты';
        return;
      }
      const agid = dec?.ag ?? params.get('ag');
      const tid = dec?.tm ?? params.get('tm');
      const arrow=document.getElementById('arrow');
      const distEl=document.getElementById('dist');
      const info=document.getElementById('info');
      if(!('geolocation' in navigator)){ info.textContent='Геолокация не поддерживается'; return; }
      function setBg(dist){
        const max = Math.max(radius*10, 200);
        const t = Math.max(0, Math.min(1, 1 - dist/max));
        const r = Math.round(30 + (1-t)*120);
        const g = Math.round(40 + t*180);
        const b = 30;
        document.body.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
      }
      // убираем графику компаса — оставляем крупные цифры расстояния
      const onpos = (pos)=>{
        const {latitude, longitude} = pos.coords;
        const d=haversine(latitude, longitude, tLat, tLon);
        distEl.textContent=d+" м";
        info.textContent="Радиус: "+radius+" м";
        if(d<=radius){ validate(agid, tid); }
        setBg(d);
      };
      const onerr = (err)=>{ info.textContent='Ошибка геолокации: '+err.message; };
      navigator.geolocation.watchPosition(onpos, onerr, {enableHighAccuracy:true, maximumAge:0, timeout:10000});
      setInterval(()=>navigator.geolocation.getCurrentPosition(onpos, onerr, {enableHighAccuracy:true}), 5000);
    });
  </script>
  </head>
<body>
  <div class="dist" id="dist">— м</div>
  <div class="info" id="info">Инициализация…</div>
</body>
</html>


