<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#39d98a"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <!-- Telegram WebApp specific meta tags -->
  <meta name="telegram:web_app" content="true"/>
  <meta name="telegram:web_app:version" content="6.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' https: data: blob:; connect-src 'self' https: wss:;">
  <!-- Telegram WebApp API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>–ö–æ–º–ø–∞—Å</title>
  <style>
    /* ====== –¢–í–û–ò –°–¢–ò–õ–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ====== */
  </style>
  <script>
    // === –†–ê–ù–ù–Ø–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP ===
    (function() {
      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
      }
    })();

    // === –£–¢–ò–õ–ò–¢–´ ===
    function b64urlToStr(b64){
      b64 = b64.replace(/-/g,'+').replace(/_/g,'/');
      const pad = b64.length % 4;
      if (pad) b64 += '='.repeat(4-pad);
      return atob(b64);
    }

    function tryDecodePayload(){
      const sp = new URLSearchParams(location.search);
      let p = sp.get('p');
      if (!p && location.hash.startsWith('#')) {
        p = new URLSearchParams(location.hash.substring(1)).get('p');
      }
      if (!p) {
        return null;
      }

      try {
        const json = b64urlToStr(p);
        const result = JSON.parse(json);
        return result;
      } catch(e) {
        return null;
      }
    }

    function toRad(d){ return d*Math.PI/180 }
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371000, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return Math.round(R*c);
    }

    // === –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ë–û–¢–ê ===
    function notifyBot(uid){
      if (window.Telegram?.WebApp) {
        try {
          window.Telegram.WebApp.ready();
          const data = JSON.stringify({
            action: 'compass_success',
            uid: uid,
            ts: Date.now()
          });
          if (typeof window.Telegram.WebApp.sendData === 'function') {
            window.Telegram.WebApp.sendData(data);
            setTimeout(() => { window.Telegram.WebApp.close(); }, 500);
          } else {
            setTimeout(() => window.close(), 1000);
          }
        } catch(e){
          setTimeout(() => window.close(), 1000);
        }
      } else {
        setTimeout(()=>window.close(), 1000);
      }
    }

    // === –≠–§–§–ï–ö–¢–´ (createPulseWave, createSuccessWaves, updateWaveIntensity, updateDistanceColor) ===
    /* ... (–æ—Å—Ç–∞–≤–∏–ª —Ç–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */

    // === PELENGATOR FUNCTIONS ===
    let audioContext = null;
    let pelengatorActive = false;
    let currentFrequency = 440; // –ù–∞—á–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞
    let currentVolume = 0.1;

    function activatePelengator() {
      if (pelengatorActive) {
        deactivatePelengator();
        return;
      }
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        pelengatorActive = true;
        document.getElementById('pelengatorBtn').textContent = 'üîá –û—Ç–∫–ª—é—á–∏—Ç—å –ø–µ–ª–µ–Ω–≥–∞—Ç–æ—Ä';
        document.getElementById('pelengatorBtn').classList.add('disabled');
        console.log('–ü–µ–ª–µ–Ω–≥–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
        if (audioContext.state === 'suspended') {
          audioContext.resume().then(() => { startPelengatorSound(); });
        } else {
          startPelengatorSound();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–µ–ª–µ–Ω–≥–∞—Ç–æ—Ä–∞:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–µ–ª–µ–Ω–≥–∞—Ç–æ—Ä. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∞—É–¥–∏–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
      }
    }

    function deactivatePelengator() {
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      pelengatorActive = false;
      document.getElementById('pelengatorBtn').textContent = 'üîä –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–µ–ª–µ–Ω–≥–∞—Ç–æ—Ä';
      document.getElementById('pelengatorBtn').classList.remove('disabled');
      console.log('–ü–µ–ª–µ–Ω–≥–∞—Ç–æ—Ä –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    }

    function startPelengatorSound() {
      if (!audioContext || !pelengatorActive) return;
      if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => { startPelengatorSound(); });
        return;
      }
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(currentFrequency, audioContext.currentTime);
      gainNode.gain.setValueAt(currentVolume, audioContext.currentTime);
      oscillator.start();
      setTimeout(() => {
        oscillator.stop();
        if (pelengatorActive) {
          setTimeout(() => startPelengatorSound(), 1000);
        }
      }, 500);
    }

    /* === –í–°–¢–ê–í–õ–ï–ù–ù–ê–Ø –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø === */
    function updatePelengatorFrequency(distance, radius) {
      if (!pelengatorActive) return;
      let frequency;
      if (distance <= radius) {
        frequency = 800;
      } else if (distance <= radius * 2) {
        frequency = 600;
      } else if (distance <= radius * 5) {
        frequency = 400;
      } else {
        frequency = 200;
      }
      currentFrequency = frequency;
      if (typeof _updateSoundFrequency === 'function') {
        _updateSoundFrequency(currentFrequency);
      }
    }

    // === MAIN ===
    window.addEventListener('DOMContentLoaded', ()=>{
      const payload = tryDecodePayload();
      const tLat = parseFloat(payload?.lat ?? new URLSearchParams(location.search).get('lat'));
      const tLon = parseFloat(payload?.lon ?? new URLSearchParams(location.search).get('lon'));
      const radius = parseInt(payload?.r ?? new URLSearchParams(location.search).get('r') ?? 15, 10);
      const uid = payload?.uid ?? new URLSearchParams(location.search).get('uid');
      const distEl = document.getElementById('distance');
      const infoEl = document.getElementById('info');
      const statusEl = document.getElementById('status');
      if (Number.isNaN(tLat) || Number.isNaN(tLon)){
        infoEl.innerHTML = '<span class="status-indicator error"></span>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã';
        return;
      }
      let fired = false;
      let lastDistance = null;
      const onpos = (pos) => {
        const {latitude, longitude} = pos.coords;
        const d = haversine(latitude, longitude, tLat, tLon);
        if (lastDistance !== null && Math.abs(d - lastDistance) > 10) {
          distEl.style.transform = 'scale(1.1)';
          setTimeout(() => { distEl.style.transform = 'scale(1)'; }, 150);
          createPulseWave();
        }
        distEl.textContent = d + " –º";
        updateDistanceColor(d, radius);
        updateWaveIntensity(d, radius);
        updatePelengatorFrequency(d, radius);
        infoEl.innerHTML = `<span class="status-indicator"></span>–†–∞–¥–∏—É—Å: ${radius} –º`;
        if (!fired && d <= radius) {
          fired = true;
          statusEl.innerHTML = '<span class="status-indicator success"></span>–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!';
          distEl.classList.add('close');
          createSuccessWaves();
          if (pelengatorActive) { deactivatePelengator(); }
          if (typeof _stopAllAudio === 'function') { _stopAllAudio(); }
          notifyBot(uid);
        }
        lastDistance = d;
      };
      const onerr = (err) => { 
        infoEl.innerHTML = `<span class="status-indicator error"></span>–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ${err.message}`;
      };
      if (!('geolocation' in navigator)) {
        infoEl.innerHTML = '<span class="status-indicator error"></span>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
        return;
      }
      infoEl.innerHTML = '<span class="status-indicator"></span>–ü–æ–∏—Å–∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';
      navigator.geolocation.watchPosition(onpos, onerr, {enableHighAccuracy: true});
      setInterval(() => navigator.geolocation.getCurrentPosition(onpos, onerr, {enableHighAccuracy: true}), 5000);
    });

    // ====== –í–°–ï –û–°–¢–ê–õ–¨–ù–û–ï (–∑–≤—É–∫, –∫–Ω–æ–ø–∫–∏ –∏ —Ç.–ø.) –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ======
  </script>
</head>
<body>
  <!-- ====== –¢–í–û–Ø –í–Å–†–°–¢–ö–ê (–æ—Å—Ç–∞–≤–∏–ª –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ====== -->
</body>
</html>
